<?php

class MWDViewListsGenerete_csv {
	////////////////////////////////////////////////////////////////////////////////////////
	// Events                                                                             //
	////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////
	// Constants                                                                          //
	////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////
	// Variables                                                                          //
	////////////////////////////////////////////////////////////////////////////////////////
	private $model;

	////////////////////////////////////////////////////////////////////////////////////////
	// Constructor & Destructor                                                           //
	////////////////////////////////////////////////////////////////////////////////////////
	public function __construct($model) {
		$this->model = $model;
	}
  
	////////////////////////////////////////////////////////////////////////////////////////
	// Public Methods                                                                     //
	////////////////////////////////////////////////////////////////////////////////////////
	public function display() {
		$list_id = $_REQUEST['list_id'];
		$params = $this->model->get_data($list_id);
	
		$send_header = (int)$_REQUEST['send_header'];
		$keys_array = $params[0];
		$data = $params[1]; 
		$list_name = $params[2];
	
		$upload_dir = wp_upload_dir();
		$file_path = $upload_dir['basedir'] . '/wd-mailchimp'; 
		if (!is_dir($file_path)) { 
			mkdir($file_path, 0777); 
		} 
		$tempfile = $file_path.'/export'.$list_id.'.txt';
		if($send_header == 0 && file_exists ($tempfile))
			unlink($tempfile);
		
		$output = fopen($tempfile, "a");
		if($send_header == 0) {
			fputcsv($output, $keys_array);
		}

		if($send_header == 1){
			foreach ($data as $key => $record) {
				fputcsv($output, $record);
			}

			fclose($output);
			$txtfile = fopen($tempfile, "r");
			$txtfilecontent = fread($txtfile, filesize($tempfile));
			fclose($txtfile);

			$filename = $list_name . "_" . date('Ymd') . ".csv";
			header('Content-Encoding: Windows-1252');
			header('Content-type: text/csv; charset=Windows-1252');
			header("Content-Disposition: attachment; filename=\"$filename\"");
			
			echo $txtfilecontent;
			unlink($tempfile);
			die(); 
		} 

	}

  ////////////////////////////////////////////////////////////////////////////////////////
  // Getters & Setters                                                                  //
  ////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////
  // Private Methods                                                                    //
  ////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////
  // Listeners                                                                          //
  ////////////////////////////////////////////////////////////////////////////////////////
}